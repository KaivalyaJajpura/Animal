<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vet Dashboard - Monitoring Overview</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="../Static/Css/style.css" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec5b",
                        "background-light": "#f6f8f6",
                        "background-dark": "#102216",
                        "surface": "#ffffff",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "1rem",
                        "xl": "1.5rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .filled-icon { font-variation-settings: 'FILL' 1 !important; }
        .conic-chart {
            background: conic-gradient(#ef4444 0% 10%, #f59e0b 10% 35%, #13ec5b 35% 100%);
            border-radius: 50%;
        }
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        .modal-content {
            animation: modalFadeIn 0.2s ease-out;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#111813] antialiased">
    <div class="flex h-screen w-full overflow-hidden">
        <!-- Sidebar -->
        <aside class="hidden lg:flex flex-col w-72 bg-white border-r border-[#f0f4f2] h-full shrink-0">
            <div class="flex flex-col h-full p-4 justify-between">
                <div class="flex flex-col gap-8">
                    <div class="flex items-center gap-3 px-2">
                        <div class="bg-primary/20 flex items-center justify-center rounded-xl size-10 text-primary">
                            <span class="material-symbols-outlined filled-icon">pets</span>
                        </div>
                        <h1 class="text-[#111813] text-lg font-bold leading-normal" data-i18n="vet.livestock_health">Livestock Health</h1>
                    </div>
                    <nav class="flex flex-col gap-2">
                        <a class="flex items-center gap-3 px-4 py-3 rounded-xl bg-primary text-[#111813] shadow-sm shadow-primary/20" href="{{ url_for('vetdashboard') }}">
                            <span class="material-symbols-outlined filled-icon">dashboard</span>
                            <p class="text-sm font-bold" data-i18n="vet.dashboard">Dashboard</p>
                        </a>
                        <a class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-[#f0f4f2] text-[#637588] transition-colors" href="{{ url_for('vet_notifications') }}">
                            <span class="material-symbols-outlined">notifications</span>
                            <p class="text-sm font-medium" data-i18n="vet.notifications">Notifications</p>
                        </a>
                        <a class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-[#f0f4f2] text-[#637588] transition-colors" href="{{ url_for('vet_history') }}">
                            <span class="material-symbols-outlined">history</span>
                            <p class="text-sm font-medium" data-i18n="vet.history">History</p>
                        </a>
                        <a class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-[#f0f4f2] text-[#637588] transition-colors" href="{{ url_for('vet_settings') }}">
                            <span class="material-symbols-outlined">settings</span>
                            <p class="text-sm font-medium" data-i18n="vet.settings">Settings</p>
                        </a>
                    </nav>
                </div>
                <div class="flex flex-col gap-2">
                    <a href="{{ url_for('vet_logout') }}" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-red-50 text-red-600 transition-colors">
                        <span class="material-symbols-outlined">logout</span>
                        <p class="text-sm font-medium" data-i18n="vet.logout">Logout</p>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full overflow-hidden relative">
            <!-- Top Header -->
            <header class="h-16 bg-white border-b border-[#f0f4f2] px-6 py-4 flex items-center justify-between shrink-0 z-10">
                <div class="flex items-center gap-4">
                    <button class="lg:hidden p-2 text-[#111813]"><span class="material-symbols-outlined">menu</span></button>
                    <h2 class="text-[#111813] text-xl font-bold leading-tight" data-i18n="vet.monitoring_overview">Monitoring Overview</h2>
                </div>
                <div class="flex items-center gap-4 md:gap-6">
                    <div class="hidden md:flex items-center bg-gray-100 dark:bg-gray-800 rounded-full p-1">
                        <button data-lang="en" class="px-3 py-1 rounded-full bg-white dark:bg-gray-600 shadow-sm text-xs font-semibold text-text-dark dark:text-white transition-all">English</button>
                        <button data-lang="hi" class="px-3 py-1 rounded-full text-xs font-medium text-gray-500 hover:text-text-dark dark:text-gray-400 transition-all">हिंदी</button>
                    </div>
                    <div class="h-8 w-[1px] bg-[#f0f4f2] hidden md:block"></div>
                <div class="flex items-center gap-3">
                        <div class="text-right hidden sm:block">
                            <p class="text-sm font-bold text-[#111813]" id="vetDoctorName" data-name="{{ vet_data.full_name if vet_data else vet }}">{{ vet_data.full_name if vet_data else vet }}</p>
                            <p class="text-xs font-medium text-[#637588]">ID: {{ vet_data.license_id if vet_data else 'N/A' }}</p>
                        </div>
                        <a href="{{ url_for('vet_settings') }}" class="size-10 rounded-full bg-cover bg-center border-2 border-white shadow-sm cursor-pointer hover:opacity-80 transition-opacity" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuCndGVYdzAaSugGdYe2j_M7wMD3ZcejVWHENSW9PXjoVc0_MNmKCzr_hPt0YUhtzUCbYJKaWENV9GrxhvUTnmxiDXJkTDIxFHoHcWCtbV8N0JZp0pEPp_Vmv7ED-7DjAFfc4pFOz_cnuHF7Y1ZqlhOZi8z3BM-GNQU5RFmT3OGbqCucmPvpqJWkhzipq4nMJ2iEuLcucTEiZXPriXamK8UPUeyUSkajhUqXadCakX1cEuYqrDi0EFDuARTZ9U_2PqWQ9jzSZ1ECGLE');"></a>
                    </div>
                </div>
            </header>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-4 md:p-8">
                <div class="max-w-[1200px] mx-auto flex flex-col gap-8">
                    <!-- Page Heading -->
                    <div class="flex flex-wrap justify-between items-end gap-4">
                        <div>
                            <h2 class="text-3xl font-bold text-[#111813] tracking-tight" data-i18n="vet.monitoring_overview">Monitoring Overview</h2>
                            <p class="text-[#637588] mt-1" data-i18n="vet.herd_status_today">Here's what's happening with the livestock today.</p>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="bg-white p-5 rounded-2xl border border-red-100 shadow-sm relative overflow-hidden group">
                            <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <span class="material-symbols-outlined text-red-500 text-6xl">warning</span>
                            </div>
                            <p class="text-[#637588] text-sm font-semibold mb-1" data-i18n="vet.critical_alerts">Critical Alerts</p>
                            <p class="text-3xl font-bold text-red-600" id="criticalAlertsStat">{{ stats.critical_alerts if stats else 0 }}</p>
                            <div class="mt-4 flex items-center gap-2 text-xs font-medium text-red-700 bg-red-50 w-fit px-2 py-1 rounded-lg">
                                <span class="material-symbols-outlined text-[16px]">priority_high</span>
                                <span data-i18n="vet.needs_attention">Needs immediate attention</span>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-2xl border border-amber-100 shadow-sm relative overflow-hidden group">
                            <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <span class="material-symbols-outlined text-amber-500 text-6xl">visibility</span>
                            </div>
                            <p class="text-[#637588] text-sm font-semibold mb-1" data-i18n="vet.under_observation">Under Observation</p>
                            <p class="text-3xl font-bold text-[#111813]" id="underObservationStat">{{ stats.under_observation if stats else 0 }}</p>
                            <div class="mt-4 flex items-center gap-2 text-xs font-medium text-amber-700 bg-amber-50 w-fit px-2 py-1 rounded-lg">
                                <span class="material-symbols-outlined text-[16px] filled-icon">circle</span>
                                <span data-i18n="vet.requires_follow_up">Requires follow-up</span>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-2xl border border-[#f0f4f2] shadow-sm relative overflow-hidden group">
                            <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <span class="material-symbols-outlined text-blue-500 text-6xl">notifications</span>
                            </div>
                            <p class="text-[#637588] text-sm font-semibold mb-1" data-i18n="vet.pending_appointments">Pending Appointments</p>
                            <p class="text-3xl font-bold text-[#111813]" id="activeNotificationsStat">{{ stats.active_notifications if stats else 0 }}</p>
                            <div class="mt-4 flex items-center gap-2 text-xs font-medium text-[#637588] bg-[#f0f4f2] w-fit px-2 py-1 rounded-lg">
                                <span data-i18n="vet.in_queue_review">In queue for review</span>
                            </div>
                        </div>

                    </div>

                    <!-- Main Dashboard Area -->
                    <div class="grid grid-cols-1 gap-6">
                        <div class="bg-white rounded-2xl shadow-sm border border-[#f0f4f2] flex flex-col">
                            <div class="p-6 border-b border-[#f0f4f2] flex justify-between items-center">
                                <h3 class="text-lg font-bold text-[#111813]" data-i18n="vet.patient_queue">Patient Queue</h3>
                                <div class="flex gap-2">
                                    <button id="sortByPriorityBtn" class="px-4 py-2 bg-primary text-[#111813] rounded-lg text-xs font-bold hover:bg-green-600 transition-colors" onclick="sortAppointments('priority')">
                                        <span class="material-symbols-outlined inline text-[18px] mr-1 align-middle">priority_high</span> <span data-i18n="vet.sort_priority">Sort by Priority</span>
                                    </button>
                                    <button id="sortByHealthBtn" class="px-4 py-2 bg-white border border-[#f0f4f2] text-[#111813] rounded-lg text-xs font-bold hover:bg-[#f0f4f2] transition-colors" onclick="sortAppointments('health_index')">
                                        <span class="material-symbols-outlined inline text-[18px] mr-1 align-middle">health_metrics</span> <span data-i18n="vet.sort_health">Sort by Health Index</span>
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-[#f8faf9] text-[#637588] text-xs uppercase font-semibold">
                                        <tr>
                                            <th class="px-6 py-4 rounded-tl-lg" data-i18n="vet.animal_id">Animal ID</th>
                                            <th class="px-6 py-4" data-i18n="vet.status">Status</th>
                                            <th class="px-6 py-4" data-i18n="vet.health_index">Health Index</th>
                                            <th class="px-6 py-4" data-i18n="vet.owner">Owner</th>
                                            <th class="px-6 py-4" data-i18n="vet.appointment_time">Appointment Time</th>
                                            <th class="px-6 py-4 rounded-tr-lg text-right" data-i18n="vet.action">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-sm" id="appointmentQueueBody">
                                        <tr>
                                            <td colspan="6" class="px-6 py-8 text-center text-[#637588]">
                                                <span class="material-symbols-outlined text-4xl text-gray-300 block mb-2">schedule</span>
                                                <p>No pending appointments</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden modal-content">
            <div class="p-6 border-b border-[#f0f4f2] bg-gradient-to-r from-primary/10 via-green-50 to-emerald-50">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-[#111813] flex items-center gap-3" data-i18n="vet.confirm_appointment">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary to-green-600 flex items-center justify-center shadow-lg">
                            <span class="material-symbols-outlined text-white filled-icon text-3xl">check_circle</span>
                        </div>
                        Confirm Appointment
                    </h3>
                    <button onclick="closeConfirmModal()" class="p-2 rounded-lg hover:bg-white/80 text-[#637588] hover:text-[#111813] transition-all">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>
            <div class="p-6 bg-gradient-to-b from-white to-gray-50">
                <div id="confirmAnimalInfo" class="bg-white rounded-xl p-5 mb-6 border-2 border-[#f0f4f2] shadow-sm">
                    <!-- Animal info will be populated here -->
                </div>
                <p class="text-[#637588] text-sm mb-6 leading-relaxed px-1" data-i18n="vet.confirm_appt_text">Are you sure you want to confirm this appointment? The animal will be moved to the visit queue and marked as ready for examination.</p>
                <div class="flex gap-3">
                    <button type="button" onclick="closeConfirmModal()" class="flex-1 px-6 py-3.5 bg-white border-2 border-[#f0f4f2] text-[#111813] rounded-xl text-sm font-bold hover:bg-[#f8faf9] hover:border-[#e0e8e4] transition-all flex items-center justify-center gap-2" data-i18n="vet.cancel_btn">
                        <span class="material-symbols-outlined text-lg">close</span>
                        Cancel
                    </button>
                    <button type="button" onclick="proceedConfirmAppointment()" class="flex-1 px-6 py-3.5 bg-gradient-to-r from-primary to-green-600 text-white rounded-xl text-sm font-bold hover:from-green-600 hover:to-green-700 transition-all flex items-center justify-center gap-2 shadow-lg shadow-primary/30" data-i18n="vet.confirm_btn">
                        <span class="material-symbols-outlined text-lg filled-icon">check_circle</span>
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Treatment Popup Modal -->
    <div id="treatmentModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden modal-content">
            <div class="p-6 border-b border-[#f0f4f2] bg-gradient-to-r from-green-50 via-emerald-50 to-teal-50">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-[#111813] flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary to-green-600 flex items-center justify-center shadow-lg">
                            <span class="material-symbols-outlined text-white filled-icon text-2xl">medical_services</span>
                        </div>
                        Mark as Treated
                    </h3>
                    <button onclick="closeTreatmentModal()" class="p-2 rounded-lg hover:bg-white/80 text-[#637588] hover:text-[#111813] transition-all">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>
            <div class="p-6 bg-gradient-to-b from-white to-gray-50">
                <div id="treatmentAnimalInfo" class="bg-white rounded-xl p-5 mb-6 border-2 border-[#f0f4f2] shadow-sm">
                    <!-- Animal info will be populated here -->
                </div>
                <form id="treatmentForm" onsubmit="submitTreatment(event)" class="space-y-5">
                    <input type="hidden" id="treatmentAppointmentId" />
                    <div>
                        <label class="block text-sm font-bold text-[#111813] mb-3 flex items-center gap-2">
                            <div class="w-6 h-6 rounded-lg bg-primary/10 flex items-center justify-center">
                                <span class="material-symbols-outlined text-[16px] text-primary">edit_note</span>
                            </div>
                            Treatment Given <span class="text-red-500 ml-1">*</span>
                        </label>
                        <textarea id="treatmentDescription" class="w-full px-4 py-3 rounded-xl border-2 border-[#f0f4f2] bg-white text-sm text-[#111813] placeholder-[#637588] focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all resize-none shadow-sm hover:border-[#e0e8e4]" rows="4" placeholder="Enter treatment details (e.g., Antibiotics Course, Vaccination, Surgery, etc.)" required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-[#111813] mb-3 flex items-center gap-2">
                            <div class="w-6 h-6 rounded-lg bg-blue-50 flex items-center justify-center">
                                <span class="material-symbols-outlined text-[16px] text-blue-600">description</span>
                            </div>
                            Additional Notes <span class="text-xs font-normal text-[#637588]">(Optional)</span>
                        </label>
                        <textarea id="treatmentNotes" class="w-full px-4 py-3 rounded-xl border-2 border-[#f0f4f2] bg-white text-sm text-[#111813] placeholder-[#637588] focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all resize-none shadow-sm hover:border-[#e0e8e4]" rows="3" placeholder="Any additional notes or follow-up instructions..."></textarea>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="closeTreatmentModal()" class="flex-1 px-6 py-3.5 bg-white border-2 border-[#f0f4f2] text-[#111813] rounded-xl text-sm font-bold hover:bg-[#f8faf9] hover:border-[#e0e8e4] transition-all flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined text-lg">close</span>
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 px-6 py-3.5 bg-gradient-to-r from-primary to-green-600 text-white rounded-xl text-sm font-bold hover:from-green-600 hover:to-green-700 transition-all flex items-center justify-center gap-2 shadow-lg shadow-primary/30">
                            <span class="material-symbols-outlined text-lg filled-icon">check_circle</span>
                            Save & Mark Treated
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Success/Error Notification Modal -->
    <div id="notificationModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden transform transition-all animate-bounce-in">
            <div id="notificationHeader" class="p-6 border-b border-[#f0f4f2]">
                <!-- Header content will be populated dynamically -->
            </div>
            <div class="p-6">
                <p id="notificationMessage" class="text-[#637588] text-sm leading-relaxed mb-6"></p>
                <button onclick="closeNotificationModal()" id="notificationButton" class="w-full px-5 py-3 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 shadow-lg">
                    <span class="material-symbols-outlined text-lg">check</span>
                    <span id="notificationButtonText">OK</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Track current sort order
        let currentSortBy = 'priority';
        let allAppointments = [];
        let currentTreatmentAppointment = null;

        // Helper function to get translation
        function getTranslation(key) {
            if (window.i18n) {
                return window.i18n.getTranslation(key, window.i18n.currentLanguage);
            }
            return key;
        }

        // Show notification modal
        function showNotification(type, title, message, buttonText = 'OK') {
            const modal = document.getElementById('notificationModal');
            const header = document.getElementById('notificationHeader');
            const messageEl = document.getElementById('notificationMessage');
            const button = document.getElementById('notificationButton');
            const buttonTextEl = document.getElementById('notificationButtonText');

            if (type === 'success') {
                header.className = 'p-6 border-b border-[#f0f4f2] bg-gradient-to-r from-green-50 to-emerald-50';
                header.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                            <span class="material-symbols-outlined text-green-600 filled-icon text-3xl">check_circle</span>
                        </div>
                        <h3 class="text-xl font-bold text-[#111813]">${title}</h3>
                    </div>
                `;
                button.className = 'w-full px-5 py-3 bg-primary text-[#111813] rounded-xl text-sm font-bold hover:bg-green-600 transition-all flex items-center justify-center gap-2 shadow-lg shadow-primary/20';
            } else if (type === 'error') {
                header.className = 'p-6 border-b border-[#f0f4f2] bg-gradient-to-r from-red-50 to-rose-50';
                header.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                            <span class="material-symbols-outlined text-red-600 filled-icon text-3xl">error</span>
                        </div>
                        <h3 class="text-xl font-bold text-[#111813]">${title}</h3>
                    </div>
                `;
                button.className = 'w-full px-5 py-3 bg-red-500 text-white rounded-xl text-sm font-bold hover:bg-red-600 transition-all flex items-center justify-center gap-2 shadow-lg shadow-red-500/20';
            } else if (type === 'warning') {
                header.className = 'p-6 border-b border-[#f0f4f2] bg-gradient-to-r from-amber-50 to-yellow-50';
                header.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center">
                            <span class="material-symbols-outlined text-amber-600 filled-icon text-3xl">warning</span>
                        </div>
                        <h3 class="text-xl font-bold text-[#111813]">${title}</h3>
                    </div>
                `;
                button.className = 'w-full px-5 py-3 bg-amber-500 text-white rounded-xl text-sm font-bold hover:bg-amber-600 transition-all flex items-center justify-center gap-2 shadow-lg shadow-amber-500/20';
            }

            messageEl.textContent = message;
            buttonTextEl.textContent = buttonText;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Close notification modal
        function closeNotificationModal() {
            const modal = document.getElementById('notificationModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Get status badge color
        function getStatusBadgeColor(status) {
            const colors = {
                'Healthy': { bg: 'bg-green-100', text: 'text-green-700', icon: '#10b981' },
                'Warning': { bg: 'bg-amber-100', text: 'text-amber-700', icon: '#f59e0b' },
                'Ill': { bg: 'bg-red-100', text: 'text-red-700', icon: '#ef4444' },
                'Critical': { bg: 'bg-red-100', text: 'text-red-700', icon: '#ef4444' }
            };
            return colors[status] || { bg: 'bg-gray-100', text: 'text-gray-700', icon: '#6b7280' };
        }

        // Get animal icon based on species
        function getAnimalIcon(species) {
            const icons = {
                'Cow': 'grass',
                'Buffalo': 'pets',
                'Goat': 'pest_control_rodent',
                'Sheep': 'pets',
                'Horse': 'egg',
                'Pig': 'pets'
            };
            return icons[species] || 'pets';
        }

        // Get animal icon color based on species
        function getAnimalIconColor(species) {
            const colors = {
                'Cow': 'bg-blue-100 text-blue-600',
                'Buffalo': 'bg-gray-100 text-gray-600',
                'Goat': 'bg-amber-100 text-amber-600',
                'Sheep': 'bg-purple-100 text-purple-600',
                'Horse': 'bg-pink-100 text-pink-600',
                'Pig': 'bg-indigo-100 text-indigo-600'
            };
            return colors[species] || 'bg-blue-100 text-blue-600';
        }

        // Load appointments from API
        async function loadAppointments(sortBy = 'priority') {
            try {
                const response = await fetch(`/api/appointments?sort_by=${sortBy}`);
                const data = await response.json();

                if (data.status === 'success') {
                    allAppointments = data.appointments;
                    renderAppointments();
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
            }
        }

        // Render appointments table
        function renderAppointments() {
            const tbody = document.getElementById('appointmentQueueBody');
            
            if (allAppointments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-[#637588]">
                            <span class="material-symbols-outlined text-4xl text-gray-300 block mb-2">schedule</span>
                            <p>No pending appointments</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = allAppointments.map((apt, index) => {
                const statusColor = getStatusBadgeColor(apt.health_status);
                const iconClass = getAnimalIconColor(apt.animal_species);
                const animalIcon = getAnimalIcon(apt.animal_species);
                const appointmentDate = new Date(apt.appointment_time);
                const timeStr = appointmentDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                return `
                    <tr class="border-b border-[#f0f4f2] hover:bg-[#fcfdfc] group transition-colors">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full ${iconClass} flex items-center justify-center shrink-0">
                                    <span class="material-symbols-outlined">${animalIcon}</span>
                                </div>
                                <div>
                                    <p class="font-bold text-[#111813]">${apt.animal_species} #${apt.animal_tag}</p>
                                    <p class="text-xs text-[#637588]">${apt.animal_name}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold ${statusColor.bg} ${statusColor.text}">
                                <span class="w-1.5 h-1.5 rounded-full" style="background-color: ${statusColor.icon}"></span>
                                ${apt.health_status}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <p class="text-sm font-medium text-[#111813]">${apt.health_index}%</p>
                        </td>
                        <td class="px-6 py-4">
                            <p class="font-bold text-[#111813] text-sm">${apt.owner_name}</p>
                            <p class="text-xs text-[#637588]">${apt.owner_mobile}</p>
                        </td>
                        <td class="px-6 py-4 text-[#637588] font-medium text-sm">${timeStr}</td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="confirmAppointment(${apt.id})" class="px-4 py-2 bg-primary text-[#111813] rounded-lg text-xs font-bold hover:bg-green-600 transition-colors" data-i18n="vet.confirm_appointment">
                                Confirm Appointment
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Re-translate the newly added elements
            if (window.i18n) {
                window.i18n.translate(window.i18n.currentLanguage);
            }
        }

        // Refresh stats cards
        async function refreshStats() {
            try {
                const response = await fetch('/api/vet/stats');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const stats = data.stats;
                    document.getElementById('criticalAlertsStat').textContent = stats.critical_alerts;
                    document.getElementById('underObservationStat').textContent = stats.under_observation;
                    document.getElementById('activeNotificationsStat').textContent = stats.active_notifications;
                    document.getElementById('totalTreatedStat').textContent = stats.total_treated;
                }
            } catch (error) {
                console.error('Error refreshing stats:', error);
            }
        }

        // Store current appointment for confirmation
        let currentConfirmAppointment = null;

        // Show confirmation modal
        function confirmAppointment(appointmentId) {
            // Find the appointment data
            currentConfirmAppointment = allAppointments.find(apt => apt.id === appointmentId);
            if (!currentConfirmAppointment) {
                console.error('Appointment not found');
                return;
            }
            
            // Populate modal with animal info
            const statusColor = getStatusBadgeColor(currentConfirmAppointment.health_status);
            const ownerLabel = getTranslation('vet.owner');
            document.getElementById('confirmAnimalInfo').innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 rounded-xl ${getAnimalIconColor(currentConfirmAppointment.animal_species)} flex items-center justify-center shadow-sm">
                        <span class="material-symbols-outlined text-2xl filled-icon">${getAnimalIcon(currentConfirmAppointment.animal_species)}</span>
                    </div>
                    <div class="flex-1">
                        <p class="font-bold text-[#111813] text-base">${currentConfirmAppointment.animal_name}</p>
                        <p class="text-xs text-[#637588] mt-0.5">Tag: #${currentConfirmAppointment.animal_tag} • ${currentConfirmAppointment.animal_species}</p>
                        <p class="text-xs text-[#637588]">${ownerLabel}: ${currentConfirmAppointment.owner_name}</p>
                    </div>
                    <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold ${statusColor.bg} ${statusColor.text} shadow-sm">
                        <span class="w-2 h-2 rounded-full" style="background-color: ${statusColor.icon}"></span>
                        ${currentConfirmAppointment.health_status}
                    </span>
                </div>
            `;
            
            // Translate and update button text
            const cancelBtnText = getTranslation('vet.cancel_btn');
            const confirmBtnText = getTranslation('vet.confirm_btn');
            const cancelBtn = document.querySelector('#confirmModal button[onclick="closeConfirmModal()"]');
            const confirmBtn = document.querySelector('#confirmModal button[onclick="proceedConfirmAppointment()"]');
            
            if (cancelBtn) {
                const buttons = cancelBtn.querySelectorAll('*');
                const lastChild = cancelBtn.lastChild;
                if (lastChild && lastChild.nodeType === Node.TEXT_NODE) {
                    lastChild.textContent = cancelBtnText;
                } else {
                    // If no text node, create one
                    cancelBtn.appendChild(document.createTextNode(cancelBtnText));
                }
            }
            
            if (confirmBtn) {
                const buttons = confirmBtn.querySelectorAll('*');
                const lastChild = confirmBtn.lastChild;
                if (lastChild && lastChild.nodeType === Node.TEXT_NODE) {
                    lastChild.textContent = confirmBtnText;
                } else {
                    // If no text node, create one
                    confirmBtn.appendChild(document.createTextNode(confirmBtnText));
                }
            }
            
            // Show modal
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Re-translate modal content if i18n is loaded
            if (window.i18n) {
                window.i18n.translate(window.i18n.currentLanguage);
            }
        }

        // Close confirmation modal
        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentConfirmAppointment = null;
        }

        // Proceed with appointment confirmation
        function proceedConfirmAppointment() {
            if (currentConfirmAppointment) {
                markConfirmed(currentConfirmAppointment.id);
                closeConfirmModal();
            }
        }
        
        // Confirm appointment - move to confirmed appointments
        async function markConfirmed(appointmentId) {
            try {
                const response = await fetch(`/api/appointments/${appointmentId}/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (data.status === 'success') {
                    // Reload appointments
                    loadAppointments(currentSortBy);
                    // Refresh stats
                    refreshStats();
                    showNotification('success', 'Appointment Confirmed!', 'The animal has been successfully added to the visit queue and is ready for examination.');
                } else {
                    showNotification('error', 'Confirmation Failed', data.message || 'Failed to confirm appointment. Please try again.');
                }
            } catch (error) {
                console.error('Error confirming appointment:', error);
                showNotification('error', 'Error', 'An error occurred while confirming the appointment. Please try again.');
            }
        }
        
        // Keep the old function for reference (not used anymore)
        function markAppointmentTreated(appointmentId) {
            // Find the appointment data
            currentTreatmentAppointment = allAppointments.find(apt => apt.id === appointmentId);
            if (!currentTreatmentAppointment) {
                console.error('Appointment not found');
                return;
            }
            
            // Populate modal with animal info
            const statusColor = getStatusBadgeColor(currentTreatmentAppointment.health_status);
            document.getElementById('treatmentAnimalInfo').innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 rounded-xl ${getAnimalIconColor(currentTreatmentAppointment.animal_species)} flex items-center justify-center shadow-sm">
                        <span class="material-symbols-outlined text-2xl filled-icon">${getAnimalIcon(currentTreatmentAppointment.animal_species)}</span>
                    </div>
                    <div class="flex-1">
                        <p class="font-bold text-[#111813] text-base">${currentTreatmentAppointment.animal_name}</p>
                        <p class="text-xs text-[#637588] mt-0.5">Tag: #${currentTreatmentAppointment.animal_tag} • ${currentTreatmentAppointment.animal_species}</p>
                        <p class="text-xs text-[#637588]">Owner: ${currentTreatmentAppointment.owner_name}</p>
                    </div>
                    <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold ${statusColor.bg} ${statusColor.text} shadow-sm">
                        <span class="w-2 h-2 rounded-full" style="background-color: ${statusColor.icon}"></span>
                        ${currentTreatmentAppointment.health_status}
                    </span>
                </div>
            `;
            
            // Set appointment ID
            document.getElementById('treatmentAppointmentId').value = appointmentId;
            
            // Clear previous form values
            document.getElementById('treatmentDescription').value = '';
            document.getElementById('treatmentNotes').value = '';
            
            // Show modal
            const modal = document.getElementById('treatmentModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Re-translate modal content if i18n is loaded
            if (window.i18n) {
                window.i18n.translate(window.i18n.currentLanguage);
            }
        }
        
        // Close treatment modal
        function closeTreatmentModal() {
            const modal = document.getElementById('treatmentModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentTreatmentAppointment = null;
        }
        
        // Submit treatment form
        async function submitTreatment(event) {
            event.preventDefault();
            
            const appointmentId = document.getElementById('treatmentAppointmentId').value;
            const treatment = document.getElementById('treatmentDescription').value.trim();
            const notes = document.getElementById('treatmentNotes').value.trim();
            
            if (!treatment) {
                showNotification('warning', 'Missing Information', 'Please enter treatment details before submitting.');
                return;
            }
            
            try {
                const response = await fetch(`/api/appointments/${appointmentId}/mark-treated`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        treatment: treatment,
                        notes: notes
                    })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    // Close modal
                    closeTreatmentModal();
                    // Reload appointments
                    loadAppointments(currentSortBy);
                    // Refresh stats
                    refreshStats();
                    showNotification('success', 'Treatment Saved!', 'The treatment has been recorded successfully and the animal has been marked as treated.');
                } else {
                    showNotification('error', 'Save Failed', data.message || 'Failed to save treatment. Please try again.');
                }
            } catch (error) {
                console.error('Error marking appointment as treated:', error);
                showNotification('error', 'Error', 'An error occurred while saving the treatment. Please try again.');
            }
        }
        
        // Close modal when clicking outside
        document.getElementById('treatmentModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTreatmentModal();
            }
        });

        // Sort appointments
        function sortAppointments(sortBy) {
            currentSortBy = sortBy;
            
            // Update button styles
            const priorityBtn = document.getElementById('sortByPriorityBtn');
            const healthBtn = document.getElementById('sortByHealthBtn');
            
            if (sortBy === 'priority') {
                priorityBtn.classList.add('bg-primary');
                priorityBtn.classList.remove('bg-white', 'border', 'border-[#f0f4f2]');
                healthBtn.classList.remove('bg-primary');
                healthBtn.classList.add('bg-white', 'border', 'border-[#f0f4f2]');
            } else {
                healthBtn.classList.add('bg-primary');
                healthBtn.classList.remove('bg-white', 'border', 'border-[#f0f4f2]');
                priorityBtn.classList.remove('bg-primary');
                priorityBtn.classList.add('bg-white', 'border', 'border-[#f0f4f2]');
            }
            
            loadAppointments(sortBy);
        }

        // Load appointments on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadAppointments('priority');
            updateDoctorNameDisplay();
            
            // Update doctor title when language changes
            window.addEventListener('languageChanged', () => {
                updateDoctorNameDisplay();
                renderAppointments();
            });
        });
        
        // Function to update doctor name with translated title
        function updateDoctorNameDisplay() {
            const doctorNameEl = document.getElementById('vetDoctorName');
            if (doctorNameEl) {
                let fullName = doctorNameEl.getAttribute('data-name');
                // Remove any existing "Dr." or "डॉ." prefix to avoid duplication
                fullName = fullName.replace(/^(Dr\.\s*|डॉ\.\s*)/, '').trim();
                const doctorTitle = getTranslation('vet.doctor_title');
                doctorNameEl.textContent = doctorTitle + ' ' + fullName;
            }
        }
    </script>
    <script src="../Static/JS/i18n.js"></script>
    <script src="../Static/JS/script.js"></script>
</body>
</html>